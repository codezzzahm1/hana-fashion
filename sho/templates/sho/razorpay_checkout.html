{% extends 'sho/base.html' %}


{% block content %}
<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pay with Razorpay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" /> -->
  <!-- Bootstrap CSS CDN -->
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->

  <!-- Bootstrap Icons for nicer button icon -->
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"> -->

  <!-- Razorpay Checkout script -->
  <!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->
<!-- </head> -->
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body text-center p-4">
            <h2 class="card-title fw-bold mb-3 text-success">Hana Fashion</h2>
            <h2 class="card-title fw-bold mb-3 text-primary">Proceed to Pay</h2>
            <p class="text-muted mb-4 fs-6">Order <strong>#{{ order.id }}</strong></p>
            {% if vip_user %}
              <p class="text-muted mb-4 fs-6">Delivery fee: ₹0</p>
            {% else %}
              <p class="text-muted mb-4 fs-6">Delivery fee: ₹{{ order.deliverycharge }} included</p>
            {% endif %}
            <div class="display-5 mb-4 fw-semibold text-success">
              ₹{{ order.total|floatformat:2 }} 
            </div>
            <button id="rzp-button" class="btn btn-lg btn-primary w-100 fw-semibold">
              <i class="bi bi-wallet2 me-2"></i>Pay Now Securely
            </button>
            <p class="mt-3 small text-muted">
              <i class="bi bi-shield-lock-fill text-success me-1"></i>
              Your payment is secure with Razorpay
            </p>
          </div>
        </div>
        <div class="text-center mt-4">
          <a href="{% url 'cart_detail' %}" class="btn btn-link">&larr; Back to Cart</a>
        </div>
      </div>
    </div>
  </div>
  

  <script>
    var options = {
      "key": "{{ razorpay_key_id }}",
      "amount": "{{ amount|safe }}",
      "currency": "INR",
      "name": "Your Store",
      "description": "Order #{{ order.id }}",
      "order_id": "{{ razorpay_order_id }}",
      "handler": function (response) {
        var csrfToken = '{{ csrf_token }}';
        fetch("{% url 'razorpay_payment_success' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature,
            order_id: "{{ order.id }}"
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            var points = data.points_earned || 0;
            showLoyaltyPointsPopup(points);

          // Redirect after short delay to allow user to see message
          window.location.href = "{% url 'my_orders' %}";
 
          } else {
            alert('Payment failed. Please try again.');
          }
        });
      },
      "prefill": {
        "name": "{{ user.get_full_name|default:user.username }}",
        "email": "{{ user.email }}",
        "contact": "{{ phone }}"
      },
      "theme": {
        "color": "#F37254"
      }
    };
    var rzp1 = new Razorpay(options);
    document.getElementById('rzp-button').onclick = function (e) {
      rzp1.open();
      e.preventDefault();
    };

    function showLoyaltyPointsPopup(points) {
    var toastEl = document.getElementById('loyaltyToast');
    var pointsSpan = document.getElementById('toastPoints');
    pointsSpan.textContent = points.toFixed(2);

    var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
}


  </script>

 {% endblock %}
