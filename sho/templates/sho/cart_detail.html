{% extends 'sho/base.html' %}
{% block content %}

<style>
  /* Responsive adjustments for Cart Page */
  @media (max-width: 600px) {
    .container {
      padding-left: 0.5rem !important;
      padding-right: 0.5rem !important;
    }
    .table-responsive {
      border-radius: 0.7rem;
      /* Enable easier scrolling on mobile */
      overflow-x: auto;
    }
    .table thead th,
    .table td {
      font-size: 0.93rem; /* Slightly smaller text */
      padding: 0.5rem 0.4rem !important;
      white-space: nowrap;
    }
    .card, .alert, .modal-content, .alert-info {
      max-width: 100% !important;
    }
    .card.px-4 {
      padding-left: 0.5rem !important;
      padding-right: 0.5rem !important;
    }
    .card.py-3 {
      padding-top: 0.75rem !important;
      padding-bottom: 0.75rem !important;
    }
    /* Loyalty points section: stack on smaller screens */
    .row.align-items-center {
      flex-direction: column !important;
    }
    .row.align-items-center > div {
      width: 100% !important;
      margin-bottom: 1rem;
    }
    .alert-info {
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
      padding: 0.7rem !important;
    }
    .input-group.input-group-sm {
      max-width: 100% !important;
    }
    .input-group .form-control {
      font-size: 1rem !important;
      height: 40px !important;
    }
    .btn-outline-secondary, .btn-success, .btn-gradient {
      font-size: 1.03rem;
      height: 40px !important;
    }
    /* Make modal full screen on mobile for easier input */
    .modal-dialog.modal-xl {
      max-width: 100vw !important;
      margin: 0 !important;
    }
    .modal-content.bg-glass {
      border-radius: 0.8rem !important;
      padding: 0.7em !important;
    }

    /* Hide extra icons or reduce their size if needed */
    .bi.fs-4, .bi.fs-5, .bi.fs-1 {
      font-size: 1.3em !important;
    }
    /* Hide Product Color name if tight for space */
    td .text-muted {
      display: none;
    }
  }
</style>


<style>
/* Hide the card list on desktop, show only on mobile */
@media (min-width: 601px) {
  .cart-list-mobile { display: none; }
}
/* Hide the table on mobile, show the card layout */
@media (max-width: 600px) {
  .cart-table-desktop { display: none; }
  .cart-list-mobile { display: block; }
}
.cart-item-card {
  background: #fff;
  box-shadow: 0 1px 6px #e3e1eb80;
  border-radius: 0.8rem;
  margin-bottom: 1rem;
  padding: 0.85rem 1rem;
  display: flex;
  gap: 0.7rem;
  align-items: center;
}
.cart-item-img {
  width: 64px; height: 64px;
  object-fit: cover;
  border-radius: 0.5rem;
  box-shadow: 0 0.5px 2px #e3e1eb;
}
.cart-item-details {
  flex: 1;
  min-width: 0;
}
.cart-item-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  align-items: flex-end;
}
.cart-item-title {
  font-weight: 600;
  font-size: 1.07rem;
}
.cart-item-subtext {
  font-size: 0.92rem;
  color: #888;
}
.cart-item-price,
.cart-item-total {
  font-weight: 600;
}
</style>



<div class="container mt-5">
  <h3 class="mb-3 fw-semibold">Your Cart</h3>

  {% if cart_items %}
   
    <div class="cart-list-mobile" style="margin-bottom:2rem;">
  {% for item in cart_items %}
    <div class="cart-item-card">
      {% if item.image %}
        <img src="{{ item.image }}" alt="{{ item.name }}" class="cart-item-img">
      {% endif %}
      <div class="cart-item-details">
        <div class="cart-item-title">{{ item.name }}</div>
        {% if item.color_name %}
          <div class="cart-item-subtext">Color: {{ item.color_name }}</div>
        {% endif %}
        <div class="cart-item-price">Price: â‚¹{{ item.price }}</div>
        <div>
          <span class="cart-item-subtext">Qty:</span>
          <div class="input-group input-group-sm" style="width:120px;display:inline-flex;">
            <button type="button" class="btn btn-outline-secondary decrement-btn" data-key="{{ item.color_id }}">
              <i class="bi bi-dash-lg"></i>
            </button>
            <input type="text" readonly class="form-control text-center quantity-input"
                   value="{{ item.quantity }}" data-key="{{ item.color_id }}" style="user-select:none;">
            <button type="button" class="btn btn-outline-secondary increment-btn" data-key="{{ item.color_id }}">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>
        <div class="cart-item-total-{{ item.color_id }} mt-1">Total: â‚¹{{ item.total|floatformat:0 }}</div>
      </div>
      <div class="cart-item-actions">
        <a href="{% url 'remove_from_cart' item.color_id %}" class="text-danger fs-5" title="Remove Item">
          <i class="bi bi-trash"></i>
        </a>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-warning text-center rounded-3 shadow-sm mt-5">
      Your cart is empty.
    </div>
  {% endfor %}
</div>





    <div class="table-responsive shadow-sm rounded cart-table-desktop">
      <table class="table align-middle table-hover mb-0">
        <thead class="table-light text-uppercase small text-muted">
          <tr>
            <th scope="col" style="width: 70px;">Image</th>
            <th scope="col">Product</th>
            <th scope="col" style="width: 100px;">Price</th>
            <th scope="col" style="width: 140px;">Quantity</th>
            <th scope="col" style="width: 120px;">Total</th>
            <th scope="col" style="width: 50px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
          <tr>
            <td>
              {% if item.image %}
                <img src="{{ item.image }}" alt="{{ item.name }}" 
                     class="rounded-3 shadow-sm" 
                     style="width: 56px; height: 56px; object-fit: cover;">
              {% endif %}
            </td>
            <td class="align-middle">
              <div class="fw-semibold">{{ item.name }}</div>
              <small class="text-muted">Color: {{ item.color_name }}</small>
            </td>
            <td class="align-middle fw-semibold text-nowrap">â‚¹{{ item.price }}</td>
            <td class="align-middle">
              <div class="input-group input-group-sm" style="max-width: 140px;">
                <button type="button" class="btn btn-outline-secondary decrement-btn" data-key="{{ item.color_id }}">
                  <i class="bi bi-dash-lg"></i>
                </button>
                <input type="text" readonly class="form-control text-center quantity-input" 
                       value="{{ item.quantity }}" data-key="{{ item.color_id }}" 
                       style="user-select:none;">
                <button type="button" class="btn btn-outline-secondary increment-btn" data-key="{{ item.color_id }}">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </td>
            <td class="align-middle fw-semibold text-nowrap total-price" data-key="{{ item.color_id }}">
              â‚¹{{ item.total|floatformat:0 }}
            </td>
            <td class="align-middle text-center">
              <a href="{% url 'remove_from_cart' item.color_id %}" 
                 class="text-danger fs-5" 
                 title="Remove Item">
                <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="alert alert-success rounded-3 shadow mt-4">
      {% if request.user.profile.first_order_offer_used %}
        ðŸŽ‰ <strong>10% Discount Applied!</strong>
      {% else %}
        ðŸŽ‰ <strong>5% Discount Applied!</strong>
      {% endif %}
      <br>
      <span class="fw-semibold ajax-discount">â‚¹{{ discount }}</span> saved on this order. YAY!
    </div>

    {% if vip_user %}
     <div class="alert alert-success rounded-3 shadow mt-4">
      ðŸŽ‰ <strong>VIP Offer!</strong>
      No delivery charges for you. YAY!
    </div>
    {% endif %}

    <div class="d-flex justify-content-end mt-4">
      <div class="card shadow-sm px-4 py-3" style="max-width: 720px; width: 100%;">
        <div class="row align-items-center gx-4">
          <!-- Order Totals -->
          <div class="col-12 col-md-6">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted fs-6">Order Total</span>
              <strong class="fs-5">â‚¹<span id="originalTotal" class="total-sum">{{ total_sum|floatformat:2 }}</span></strong>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <span class="text-success fs-6">Discount from Loyalty Points</span>
              <strong class="text-success fs-5">âˆ’ â‚¹<span id="pointsDiscount">0</span></strong>
            </div>

            <hr class="my-3">

            <div class="d-flex justify-content-between">
              <span class="text-primary fw-bold fs-6">Total to Pay</span>
              <strong class="text-primary fs-4">â‚¹<span id="finalTotal" >{{ total_sum|floatformat:2 }}</span></strong>
            </div>
          </div>

          <!-- Loyalty Points Redeem -->
          <div class="col-12 col-md-6">
            <div class="alert alert-info d-flex flex-column align-items-end px-3 py-2 rounded shadow-sm" style="max-width: 320px; margin-left:auto;">
              <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-wallet2 fs-4 me-2 text-info"></i>
                  <span class="fw-semibold fs-6">Loyalty Points Balance:</span>
                </div>
                <strong class="fs-5">{{ user.profile.loyaltypoints|floatformat:2 }}</strong>
              </div>

              <label for="redeem_points" class="form-label fw-semibold mb-1">
                Redeem Points (â‚¹1 per point):
              </label>

              <div class="input-group input-group-sm" style="max-width: 140px;">
                <button class="btn btn-outline-secondary d-flex align-items-center justify-content-center px-2" type="button" id="decrement-loyalty" style="width: 38px; height: 38px;">
                  <i class="bi bi-dash-lg fs-5 m-0"></i>
                </button>
                <input 
                  type="number" 
                  id="redeem_points" 
                  name="redeem_points"
                  min="0"
                  max="{{ user.profile.loyaltypoints|floatformat:0 }}"
                  class="form-control text-center"
                  value="0"
                  aria-describedby="redeemHelp"
                  readonly
                  style="width: 50px; height: 38px; user-select:none;"
                />
                <button class="btn btn-outline-secondary d-flex align-items-center justify-content-center px-2" type="button" id="increment-loyalty" style="width: 38px; height: 38px;">
                  <i class="bi bi-plus-lg fs-5 m-0"></i>
                </button>
              </div>

              <small id="redeemHelp" class="form-text text-muted fs-7 text-center" style="max-width: 260px;">
                Redeem up to your points for discount.
              </small>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#checkoutModal">
            Proceed to Checkout&nbsp;<i class="bi bi-cart-check ms-1"></i>
          </button>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-warning text-center py-4 rounded-3 shadow-sm mt-5" role="alert" style="font-size:1.2rem;">
      Your cart is empty.
    </div>
  {% endif %}
</div>

<!-- Add Bootstrap Icons CDN if not loaded -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  /* Minor style adjustments */
  .table-hover tbody tr:hover {
    background-color: #f9f9ff;
  }
  .quantity-input {
    user-select: none;
    font-weight: 600;
  }
  .btn-outline-secondary {
    padding: 0.15rem 0.75rem;
  }
  .ajax-discount {
    font-size: 1.25rem;
    color: #198754;
  }
</style>


<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-elegant-pink">
    <form method="post" action="{% url 'place_order' %}">
      {% csrf_token %}
      <input type="hidden" value="" class="form-control" id="redeem_points_in_modal" name="redeem_points_in_modal">
      <div class="modal-content border-0 shadow-lg p-2 bg-glass">
        <div class="modal-header border-0">
          <h3 class="modal-title fw-bold text-dark-pink" id="checkoutModalLabel" style="letter-spacing:.03em;">
            <i class="bi bi-truck me-1 text-pink"></i>
            Enter Shipping Address
          </h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="checkoutError" class="alert alert-danger d-none"></div>
          <div class="row g-4">
            <div class="col-md-7">
              <div class="mb-3">
                <label for="address" class="form-label fw-semibold">Shipping Address</label>
                <textarea id="address" name="address" class="form-control form-control-lg rounded-3 shadow-sm" required></textarea>
              </div>
              <div class="mb-3">
                <label for="pincode" class="form-label fw-semibold">Pincode</label>
                <input id="pincode" name="pincode" type="number" class="form-control form-control-lg rounded-3 shadow-sm" min="110001" max="999999" required>
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label fw-semibold">Phone</label>
                <input id="phone" name="phone" type="tel" class="form-control form-control-lg rounded-3 shadow-sm" required>
              </div>
            </div>
            <div class="col-md-5 px-3">
              <div class="bg-white bg-opacity-70 rounded-4 p-4 h-100 d-flex flex-column justify-content-center align-items-center border border-pink">
                <div class="mb-3">
                  <i class="bi bi-box-seam fs-1 text-pink"></i>
                </div>
                <div class="h5 mb-2 text-secondary">Delivery Charges</div>
                <div class="mb-1 fs-6">â‚¹60 <span class="text-muted small">(Inside Tamilnadu)</span></div>
                <div class="mb-3 fs-6">â‚¹90 <span class="text-muted small">(Outside Tamilnadu)</span></div>
                <div class="text-center small mt-auto text-pink-50"><i class="bi bi-union me-1"></i>Fast & Secure Delivery</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light btn-lg px-4 me-2" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="checkoutSubmitBtn" class="btn btn-gradient btn-lg px-4 shadow-sm">
            <i class="bi bi-credit-card-2-front me-1"></i> Place Order & Pay
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Custom Elegant Modal CSS -->
<style>
.modal-elegant-pink {
  max-width: 900px;
}
.bg-glass {
  background: linear-gradient(135deg, #fff3f8 80%, #ffffff90 100%);
  backdrop-filter: blur(7px);
  border-radius: 1.5rem;
}
.text-dark-pink {
  color: #b7266b;
}
.text-pink {
  color: #e66999;
}
.text-pink-50 {
  color: #e6699977;
}
.border-pink {
  border: 1px solid #ffe6f0 !important;
}
.btn-gradient {
  background: linear-gradient(90deg,#e65eb3 0,#fb908d 100%);
  color: #fff;
  border: none;
  transition: all 0.12s;
}
.btn-gradient:hover, .btn-gradient:focus {
  background: linear-gradient(90deg,#fb908d,#e65eb3);
  color: #fff;
}
</style>






<script>
document.addEventListener('DOMContentLoaded', function() {
  function updateCartQuantity(key, quantity) {
    const csrftoken = getCookie('csrftoken');
    fetch("{% url 'ajax_update_cart_quantity' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        key: key,
        quantity: quantity
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {

        // Update quantity input box
        const input = document.querySelector(`input.quantity-input[data-key="${data.key}"]`);
        if (input) input.value = data.quantity;

        // Update total price cell
        const totalPriceCell = document.querySelector(`td.total-price[data-key="${data.key}"]`);
        const totalPriceDivForMobile = document.querySelector(`.cart-item-total-${data.key}`);
 
        if (totalPriceCell || totalPriceDivForMobile) totalPriceCell.textContent = 'â‚¹' + data.total_price;
totalPriceDivForMobile.textContent = 'Total â‚¹' + data.total_price;
        document.querySelector('.total-sum').textContent = data.total_sum;

document.querySelector('#finalTotal').textContent = data.total_sum;
        document.querySelector('.ajax-discount').textContent = 'â‚¹' + data.ajax_discount;

document.getElementById('redeem_points').value = "0";

document.getElementById('pointsDiscount').textContent = "0";

      } else {
        alert(data.error);
      }
    })
    .catch(err => {
      console.error('Error updating cart quantity:', err);
    });
  }

  // Helper getCookie function for CSRF token from Django docs
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Event delegation for increment/decrement buttons
  document.querySelectorAll('.increment-btn').forEach(button => {
    button.addEventListener('click', () => {
      const key = button.getAttribute('data-key');
      const input = document.querySelector(`input.quantity-input[data-key="${key}"]`);
      let quantity = parseInt(input.value) || 1;
      quantity += 1;
      updateCartQuantity(key, quantity);
    });
  });

  document.querySelectorAll('.decrement-btn').forEach(button => {
    button.addEventListener('click', () => {
      const key = button.getAttribute('data-key');
      const input = document.querySelector(`input.quantity-input[data-key="${key}"]`);
      let quantity = parseInt(input.value) || 1;
      if (quantity > 1) {
        quantity -= 1;
        updateCartQuantity(key, quantity);
      }
    });
  });
});


document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('redeem_points');
  const input_in_modal = document.getElementById('redeem_points_in_modal');
  const incrementBtn = document.getElementById('increment-loyalty');
  const decrementBtn = document.getElementById('decrement-loyalty');
  const pointsDiscountSpan = document.getElementById('pointsDiscount');
  const finalTotalSpan = document.getElementById('finalTotal');
  
  const maxPoints = parseInt(input.getAttribute('max'), 10) || 0;
  const minPoints = parseInt(input.getAttribute('min'), 10) || 0;

  // Function to update UI
  function updateTotalWithRedeem() {

    let originalTotal = parseFloat(document.getElementById('originalTotal').textContent) || 0;

    let redeemPoints = parseInt(input.value) || 0;
    // Clamp value (shouldn't be necessary, but for safety)
    redeemPoints = Math.min(Math.max(redeemPoints, minPoints), maxPoints);
    input.value = redeemPoints;

    const newTotal = Math.max(originalTotal - redeemPoints, 0);

    pointsDiscountSpan.textContent = redeemPoints.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    finalTotalSpan.textContent = newTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    input_in_modal.value = redeemPoints
  }

  // Increment button action
  incrementBtn.addEventListener('click', function() {
    let current = parseInt(input.value) || 0;
    if (current < maxPoints) {
      input.value = current + 1;
      updateTotalWithRedeem();
    }
  });

  // Decrement button action
  decrementBtn.addEventListener('click', function() {
    let current = parseInt(input.value) || 0;
    if (current > minPoints) {
      input.value = current - 1;
      updateTotalWithRedeem();
    }
  });

  // Initialize UI at start
  updateTotalWithRedeem();
});


</script>

{% endblock %}
